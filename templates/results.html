{% extends "base.html" %}

{% block title %}Результаты - Tashkents Masters League{% endblock %}

{% block head %}
<style>
    .gridjs-container {
        margin-bottom: 20px;
    }
    .gridjs-search {
        float: right;
    }
    .flag-icon {
        width: 20px;
        margin-right: 5px;
    }
</style>
{% endblock %}

{% block content %}
<h1 class="mb-4">Итоги сезонов</h1>

    <div class="mb-4 col-6">
    <h5>Сезоны</h5>
    <div class="btn-group" role="group">

        {% if selected_season_id %}
            <a href="/results" id="sball" type="button" class="btn btn-outline-primary">Все</a>
        {% else %}
            <a href="/results"  id="sball" type="button" class="btn btn-outline-primary active">Все</a>
        {% endif %}
        {% for season in seasons %}
            {% if season.id == selected_season_id %}
                <a href="/results?season_id={{season.id}}" id="sb{{season.id}}" type="button" class="btn btn-outline-primary active">{{ season.year }}/{{ season.name }}</a>
            {% else %}
                <a href="/results?season_id={{season.id}}" type="button" class="btn btn-outline-primary">{{ season.year }}/{{ season.name }}</a>
            {% endif %}
        {% endfor %}
    </div>
</div>

    {% if selected_season_id %}
    <div class="mb-4 col-6">
        <h5>Дивизионы</h5>
        <div class="btn-group" role="group">
            {% if selected_division_id %}
                <a href="/results" id="sball" type="button" class="btn btn-outline-primary">Все</a>
            {% else %}
                <a href="/results"  id="sball" class="btn btn-outline-primary active" type="button">Все</a>
            {% endif %}
            {% for division in divisions %}
                {% if division.id == selected_division_id %}
                    <a href="/results?season_id={{selected_season_id}}&division_id={{division.id}}" id="sb{{selected_season_id}}_{{division.id}}" type="button" class="btn btn-outline-primary active">{{ division.name }}</a>
                {% else %}
                    <a href="/results?season_id={{selected_season_id}}&division_id={{division.id}}" id="sb{{selected_season_id}}_{{division.id}}" type="button" class="btn btn-outline-primary">{{ division.name }}</a>
                {% endif %}

            {% endfor %}
        </div>
    </div>
    {% endif %}

<div id="players-table"></div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const results = {{ results|tojson|safe }};

        const formattedResults = results.map(player => {
            return {
                rank: player.id,  // Will be updated to actual rank after sorting
                name: `${player.first_name} ${player.last_name}`,
                position: `${player.position}`,
                match_count: `${player.match_count}`,
                win_count: `${player.win_count}`,
                relegation: `${player.relegation}`,
                season: `${player.season}`,
                division: `${player.division}`,
                player_id: `${player.player_id}`
            };

        });

        new gridjs.Grid({
            columns: [
                { id: 'season', name: 'Сезон', width: '100px' },
                { id: 'division', name: 'Дивизион', width: '80px' },
                {
                    id: 'name',
                    name: 'Игрок',
                    formatter: (cell) => gridjs.html(`<a href="/player/${results.find(p => `${p.first_name} ${p.last_name}` === cell).player_id}">${cell}</a>`)
                },
                { id: 'position', name: 'Место', width: '80px' },
                { id: 'match_count', name: 'Матчей', width: '80px' },
                { id: 'win_count', name: 'Побед', width: '80px' },
                { id: 'relegation', name: 'Переход', width: '100px' },
            ],
            data: formattedResults,
            search: true,
            sort: true,
            pagination: {
                limit: 15
            },
            style: {
                table: {
                    'white-space': 'nowrap'
                }
            }
        }).render(document.getElementById('players-table'));
    });
</script>
{% endblock %}